---
aliases:
  - スクリプトの概要
title: スクリプトの概要
---
このページでは、RealTrainMod（RTM）のアドオン制作に使用するスクリプトについて説明します。

## スクリプトとは
RTMのスクリプトは、デフォルトでは対応していない高度な機能を実装するために使用する、JavaScript形式のプログラムです。
スクリプトを使用すると、JSONで設定するRTMデフォルトの描画処理は行われなくなり、代わりにスクリプトが実行されます。

スクリプトは、本格的なプログラミング言語であるJavaを使用することなく、比較的平易なJavaScriptのみを使用してRTMやNGTLib、OpenGL、Minecraft、Forge、Javaなどの機能を利用できる、非常に発展性の高い機能です。

RTMでは、スクリプトで利用できる機能に制限がかけられていないので、スクリプトエンジンの制約を除けば、**ほぼ無限に近い**オリジナルの機能を実装することができます。

RealTrainModでは、Nashorn JavaScriptエンジンを使用することで、ECMAScript 5.1までに定義されたJavaScriptの機能を使用して、オリジナルの機能を実装することができます。

## スクリプトの用途
RTMでは、3種類の動作を実装するためにスクリプトを使用します。
- 描画スクリプト  
  論理クライアントで実行され、主に描画やその他のクライアント処理を実装します
- サウンドスクリプト  
  論理クライアントで実行され、主に音声の再生や停止などを実装します
- サーバースクリプト  
  論理サーバーで実行され、エンティティやブロックの状態の変更などのサーバーサイド処理を実装します

## スクリプトファイルのルール
RTMでは、スクリプトファイルについて独自のルールがあります。  
これは、RTMが開発された当初は現代のJavaScript実装であるGraalJSが開発されておらず、当時最先端のNashornエンジンを採用したためです。
### 文法はES5を使用する
KaizPatchXなど一部のバージョンではES6が部分的に利用できますが、それも部分的であるため、基本的にはECMAScript 5.1を使用します。  
また、RTMのエコシステムにはBabelなどのトランスパイラやTypeScriptコンパイラも存在しないため、ES5.1を直接コーディングする必要があります。  
これにより、現代のJavaScript教材は全てゴミ同然と化します。

具体的には、以下のような一般的に利用されている機能が使用できません。

- ブロックスコープ関数宣言 `let`、`const`
- アロー関数 `() => {}`
- クラス `class A { }`
- 重複しないコレクション型 `Set`、`Map`
- for...ofループ `for (let x of y) { }`
- モジュール `import`、`export`
- テンプレートリテラル `` `Hello, ${name}` ``
- デフォルト引数 `function f(a=1) { }`
- 分割代入 `let {a, b} = obj;`
- 多数のインスタンス・プロトタイプメソッド `Array.from()`、`string.prototype.includes()`など
- その他多数

また、古いJavaScript実行環境において新しいメソッドを利用する方法として、core-jsなどのPolyfillを定義する手段が知られていますが、これも使用すべきではありません。

一般的なPolyfillは、JavaScript仕様とできる限り同一の動作をするように実装され、そのために本質的には不要な処理が多数実行されます。  
それに対し、スクリプトは毎tick、毎フレームごとに数回またはそれ以上実行されるので、可能な限り動作を軽量化する必要があるためです。  
### 利用できる機能の確認
RTMのスクリプトで利用できるJavaScriptの機能は、Nashornエンジンが対応している機能に依存します。  
より厳密には、Nashornエンジンの独自構文も考慮する必要がありますが、基本的にはES5.1で定義されているかどうかで判断できます。

#### ES5.1で定義されているかどうかの確認方法
1. https://caniuse.com/ にアクセス
2. 利用したい機能を入力（`arrow function`, `array.prototype.find`など）
3. 「IE ⚠️」の列を確認

6-10が赤色ならば利用不可能、緑色ならば利用できると考えることができます。  

:::note[補足]
Internet ExplorerがES6への対応を開始したのはIE 11のため、それ以前のバージョンで利用できるかどうかを簡易的な対応状況の目安にします。
:::
## スクリプトの文法
JavaScriptのECMAScript 5.1部分のみについて解説した現在でも閲覧可能な貴重なウェブサイトとして、[アルファシス – alphasis.info -](http://alphasis.info/javascript/)があります。

HTMLやDOM API、windowオブジェクトなどのWeb APIについての情報は無視する必要がありますが、式や演算子、制御構文などの基本的な文法のほとんどを学ぶことができます。

また、Nashornエンジンによって拡張された、Javaクラスや、JavaオブジェクトなどのJava機能にアクセスする方法については、[Java Platform, Standard Edition Nashorn User's Guide](https://docs.oracle.com/javase/8/docs/technotes/guides/scripting/nashorn/api.html) にて確認することができます。