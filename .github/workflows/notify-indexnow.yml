name: Notify IndexNow

on:
    workflow_run:
        workflows: ['Update Sitemap'] # 既存のsitemap生成後にトリガー
        types:
            - completed

jobs:
    notify-indexnow:
        if: ${{ github.event.workflow_run.conclusion == 'success' }}
        runs-on: ubuntu-latest

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Extract URLs from sitemap.xml and notify IndexNow
              run: |
                  API_KEY="9c871a252ea34ff48cdbb80f9f9b095e"
                  SITE_URL="https://rtmwiki.kotl.io"

                  # sitemap.xmlからURLを抽出
                  grep -oP '(?<=<loc>).*?(?=</loc>)' sitemap.xml > urls.txt

                  echo "Notifying IndexNow..."
                  while read -r url; do
                  echo "Sending: $url"
                  response=$(curl -s -X POST "https://api.indexnow.org/indexnow" \
                      -H "Content-Type: application/json" \
                      -d "{\"host\": \"$SITE_HOST\", \"key\": \"$API_KEY\", \"urlList\": [\"$url\"]}")
                  echo "Response: $response"
                  done < urls.txt
